# Build script for perl.
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025, John Unland

version=5.40.0

cd -- "$TMPDIR"

rm -rf perl-$version

unpack "${worktree}/sources/perl-$version.tar.xz"

cd perl-$version

export BUILD_ZLIB=False
export BUILD_BZIP2=0

sh Configure -des \
    -D prefix=/usr \
    -D vendorprefix=/usr \
    -D privlib=/usr/lib/perl5/$version/core_perl \
    -D archlib=/usr/lib/perl5/$version/core_perl \
    -D sitelib=/usr/lib/perl5/$version/site_perl \
    -D sitearch=/usr/lib/perl5/$version/site_perl \
    -D vendorlib=/usr/lib/perl5/$version/vendor_perl \
    -D vendorarch=/usr/lib/perl5/$version/vendor_perl \
    -D man1dir=/usr/share/man/man1 \
    -D man3dir=/usr/share/man/man3 \
    -D pager="/usr/bin/less -isR" \
    -D useshrplib \
    -D usethreads

make -j${jobs}

TEST_JOBS=1 make test_harness

make install -j${jobs}

unset BUILD_ZLIB BUILD_BZIP2

if [ "$CLEANUP" == true ]; then
    cd -- "$TMPDIR" && rm -rf perl-$version
fi
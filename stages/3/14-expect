# Build script for expect.
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025, John Unland

version=5.45.4

cd -- "$TMPDIR"

rm -rf expect-$version

unpack "${worktree}/sources/expect$version.tar.gz"

cd expect$version

# Make sure PTY's are working.
python3 -c 'from pty import spawn; spawn(["echo", "ok"])'

patch -p1 <"${worktree}/patches/expect-${version}-gcc14-compact.patch"

./configure --prefix=/usr \
    --with-tcl=/usr/lib \
    --enable-shared \
    --disable-rpath \
    --mandir=/usr/share/man \
    --with-tclinclude=/usr/include

make -j${jobs}

make test -j${jobs}

make install -j${jobs}

ln -svf expect${version}/libexpect${version}.so /usr/lib/libexpect${version}.so

if [ "$CLEANUP" == true ]; then
    cd -- "$TMPDIR" && rm -rf expect-$version
fi
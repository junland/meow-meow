# Build script for bzip2.
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025, John Unland

version=1.0.8

cd -- "$TMPDIR"

rm -rf bzip2-$version

unpack "${worktree}/sources/bzip2-$version.tar.gz"

cd bzip2-$version

# Apply patch to install the documentation in the correct location.
patch -p1 <"${worktree}/patches/bzip2-$version-install-docs.patch"

# Ensure relative symlinks are created.
sed -i 's@\(ln -s -f \)$(PREFIX)/bin/@\1@' Makefile

# Ensure man pages are installed in the correct location.
sed -i 's@$(PREFIX)/man@$(PREFIX)/share/man@' Makefile

echo "Marker 1"

make -f Makefile-libbz2_so -j${jobs}

echo "Marker 2"

make clean -j${jobs}

echo "Marker 3"

make -j${jobs}

echo "Marker 4"

make PREFIX=/usr install

echo "Marker 5"

cp -av libbz2.so.* /usr/lib

ln -sv libbz2.so.1.0.8 /usr/lib/libbz2.so

cp -v bzip2-shared /usr/bin/bzip2

for i in /usr/bin/{bzcat,bunzip2}; do
  ln -sfv bzip2 $i
done

rm -fv /usr/lib/libbz2.a

cleanup() {
  cd -- "$TMPDIR" && rm -rf bzip2-$version
}
